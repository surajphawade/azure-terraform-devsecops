trigger: none

pool: dev-pool

variables:
  WORK_DIR: '$(System.DefaultWorkingDirectory)/Env-Infra/dev/'
  SPN: 'DaasWealth'




stages:
- stage: PreCommit
  displayName: Pre-Commit / Static Analysis Stage
  pool: dev-pool
  jobs: 
  - job: TerraformValidate
    displayName: Terraform Validate
    steps:
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(WORK_DIR)'
        backendServiceArm: '$(SPN)'
        backendAzureRmStorageAccountName: 'devopsinsidersstate'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'dev.tfstate'  
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(WORK_DIR)'

  - job: TerraformFmt
    dependsOn: TerraformValidate
    displayName: Terraform Fmt
    steps:
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'custom'
        environmentServiceNameAzureRM: '$(SPN)'
        workingDirectory: '$(WORK_DIR)'
        outputTo: 'console'
        customCommand: 'fmt'

  # - job: tfsec
  #   dependsOn: TerraformFmt
  #   displayName: TfSec Scan
  #   steps:
  #   - task: tfsec@1
  #     inputs:
  #       version: 'v1.26.0'
  #       dir: '$(WORK_DIR)'

  # - job: tflint
  #   dependsOn: tfsec
  #   displayName: TFLint
  #   steps:
  #   - task: PowerShell@2
  #     continueOnError: true
  #     inputs:
  #       targetType: 'inline'
  #       script: |
  #         winget install TerraformLinters.tflint     
  #         ls   
  #         tflint
  #       errorActionPreference: 'continue'        
  #       workingDirectory: '$(WORK_DIR)'

# - stage: costStage
#   dependsOn: PreCommit
#   displayName: Cost & Impact Assessment Stage
#   jobs: 
#   - job: InfraCost
#     displayName: InfraCost
#     steps:
#     - task: PowerShell@2
#       inputs:
#         targetType: 'inline'
#         script: 'infracost breakdown --path=.'
#         workingDirectory: '$(WORK_DIR)'

- stage: plan
  displayName: Plan & Review Stage
  jobs: 
  - job: TerraformPlan
    displayName: Terraform Plan
    pool: dev-pool
    steps: 

    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(WORK_DIR)'
        backendServiceArm: '$(SPN)'
        backendAzureRmStorageAccountName: 'devopsinsidersstate'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'dev.tfstate'
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(WORK_DIR)'
        environmentServiceNameAzureRM: '$(SPN)'

- stage: approval
  dependsOn: plan
  displayName: Approval & Governance Stage
  jobs:
  - job: ManualApproval
    displayName: Manual Approval
    pool: server
    steps: 
    - task: ManualValidation@1
      inputs:
        notifyUsers: 'falana@gmail.com'

- stage: apply
  dependsOn: approval
  displayName: Deploy / Apply Stage
  jobs:
  - job: TerraformApply
    displayName: Terraform Apply
    pool: dev-pool
    steps:
    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(WORK_DIR)'
        backendServiceArm: 'DaasWealth'
        backendAzureRmResourceGroupName: 'az-3-tire-rg'
        backendAzureRmStorageAccountName: 'devopsinsidersstate'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'dev.tfstate'  

    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(WORK_DIR)'
        environmentServiceNameAzureRM: 'DaasWealth'















# stages:
#   - stage: precheck
#     displayName: Static Analysis Stage
#     pool: dev-pool
#     jobs:
#       - job: Plan
#         displayName: Terraform Plan
#         steps:
#           - task: Bash@3
#             inputs:
#               targetType: 'inline'
#               script: |
#                 sudo apt-get update
#                 sudo apt-get install unzip -y
                
#                 unzip -v
#           - task: TerraformInstaller@1
#             displayName: terraform Install
#             inputs:
#               terraformVersion: 'latest'
#           - task: TerraformTask@5
#             displayName: Terrafrom init
#             inputs:
#               provider: 'azurerm'
#               command: 'init'
#               workingDirectory: '$(WORK_DIR)'
#               backendServiceArm: '$(SPN)'
#               backendAzureRmStorageAccountName: 'az3tirestorage01'
#               backendAzureRmContainerName: 'data'
#               backendAzureRmKey: 'dev.tfstate'
#           - task: TerraformTask@5
#             displayName: Terraform fmt
#             inputs:
#               provider: 'azurerm'
#               command: 'custom'
#               workingDirectory: '$(WORK_DIR)'
#               outputTo: 'console'
#               customCommand: 'fmt'
#               environmentServiceNameAzureRM: '$(SPN)'
#           - task: TerraformTask@5
#             displayName: Terraform validate
#             inputs:
#               provider: 'azurerm'
#               command: 'custom'
#               workingDirectory: '$(WORK_DIR)'
#               outputTo: 'console'
#               customCommand: 'validate'
#               environmentServiceNameAzureRM: '$(SPN)'            


#   - stage: SecureScan
#     displayName: Scan & Analaysis 
#     pool: dev-pool
#     jobs:
#     - job: SecnLinting
#       displayName: security & linting
#       steps: 
#         - task: Bash@3
#           displayName: tfsec install & scan
#           continueOnError: true
#           inputs:
#             targetType: 'inline'
#             script: |
#               curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash 
              
#               tfsec .      
#         - task: Bash@3
#           displayName: tflint install & precheck
#           continueOnError: true
#           inputs:
#             targetType: 'inline'
#             script: |
#               curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              
#               tflint --init
              
#               tflint
    


#   - stage:

#     jobs:
#       - job:
#         steps:
#         - task: TerraformInstaller@1
#           displayName: terraform Install
#           inputs:
#             terraformVersion: 'latest'
#         - task: TerraformTask@5
#           displayName: terraform init
#           inputs:
#             provider: 'azurerm'
#             command: 'init'
#             workingDirectory: '$(WORK_DIR)'
#             backendServiceArm: '$(SPN)'
#             backendAzureRmStorageAccountName: 'az3tirestorage01'
#             backendAzureRmContainerName: 'data'
#             backendAzureRmKey: 'dev.tfstate'            
#             addSpnToEnvironment: true
            
#         - task: TerraformTask@5
#           displayName: Terraform Plan
#           inputs:
#             provider: 'azurerm'
#             command: 'plan'
#             workingDirectory: '$(WORK_DIR)'
#             environmentServiceNameAzureRM: '$(SPN)'



# ##Manual Validation --Step

#   - stage: approval
#     jobs:
#     - job: ManualApproval
#       pool: server
#       steps: 
#       - task: ManualValidation@1
#         inputs:
#           notifyUsers: 'falana@gmail.com'

#   - stage: Apply
#     pool: dev-pool
#     displayName: Apply Stage
#     jobs:
#       - job: Deploy_Infra
#         displayName: terraform Apply
#         steps:

#         - task: TerraformInstaller@1
#           displayName: terraform Install
#           inputs:
#             terraformVersion: 'latest' 

#         - task: TerraformTask@5
#           displayName: terraform init
#           inputs:
#             provider: 'azurerm'
#             command: 'init'
#             workingDirectory: '$(WORK_DIR)'
#             backendServiceArm: '$(SPN)'
#             backendAzureRmStorageAccountName: 'az3tirestorage01'
#             backendAzureRmContainerName: 'data'
#             backendAzureRmKey: 'dev.tfstate'
        

#         - task: TerraformTask@5
#           displayName: Terraform Apply
#           inputs:
#             provider: 'azurerm'
#             command: 'apply'
#             workingDirectory: '$(WORK_DIR)'
#             environmentServiceNameAzureRM: '$(SPN)'

